import pandas as pd
import numpy as np

# =========================
# 0) AYARLAR / KOLON SEÃ‡Ä°MÄ°
# =========================
FILE_PATH = "MERKEZ MUTABAKATdata18112026.csv"
CSV_SEP = ";"  # gerekirse "," yap

# ZORUNLU kolonlar (CSV'nde birebir olan isimleri buraya yaz)
COL_POLICY = "PoliÃ§e NumarasÄ±"
COL_TIP = "PoliÃ§e KayÄ±t Tipi"
COL_TANZIM = "Tanzim Tarihi"

# Opsiyonel kolonlar (CSV'nde farklÄ± isimle geÃ§ebileceÄŸi iÃ§in aday listeleri)
CAND_CANCEL_REASON = ["Ä°ptal Sebebi", "Iptal Sebebi", "Ä°ptalSebebi", "IptalSebebi"]
CAND_BRANCH = ["Ana BranÅŸ", "Ana Brans", "BranÅŸ", "Brans", "ÃœrÃ¼n BranÅŸ", "Urun Brans"]
CAND_COMPANY = ["Sigorta Åirketi AdÄ±", "Sigorta Sirketi Adi", "Åirket", "Sirket", "Sigorta Åirketi", "Sigorta Sirketi"]
CAND_PRODUCT = ["ÃœrÃ¼n", "Urun", "ÃœrÃ¼n AdÄ±", "Urun Adi", "ÃœrÃ¼n Kodu", "Urun Kodu", "BranÅŸ ÃœrÃ¼n", "Brans Urun", "Plan", "Tarife"]

# Riskli segment (en yÃ¼ksek iptal oranÄ±) iÃ§in aday alanlar
# (BulduklarÄ±nÄ± otomatik deneyecek; yoksa segment analizi boÅŸ geÃ§er.)
CAND_SEGMENT = ["Sigorta Ettiren", "Sigorta Ettiren AdÄ±", "Hesap Kodu", "Acente", "Acente Kodu", "MÃ¼ÅŸteri No", "Musteri No", "TC", "TCKN"]

# Minimum adet filtresi (segment/Ã¼rÃ¼n listelerinde 1/1 gibi yanÄ±ltÄ±cÄ±larÄ± engeller)
MIN_N_FOR_RISK_LIST = 20
MIN_N_FOR_PRODUCT_RISK = 30

# YaÅŸam sÃ¼resi bucketlarÄ±
LIFE_BINS = [-1, 0, 7, 15, 30, 60, 90, 180, 365, 10_000]
LIFE_LABELS = ["0", "1-7", "8-15", "16-30", "31-60", "61-90", "91-180", "181-365", "365+"]

# =========================
# 1) YARDIMCI FONKSÄ°YONLAR
# =========================
def pick_col(df, candidates):
    """DF iÃ§inde ilk bulunan kolonu dÃ¶ndÃ¼r; yoksa None."""
    for c in candidates:
        if c in df.columns:
            return c
    return None

def normalize_tip(series):
    """PoliÃ§e KayÄ±t Tipi'ni normal/iptal olarak normalize eder."""
    s = series.astype(str).str.strip().str.lower()
    # 'iptal' iÃ§erenleri iptal say, diÄŸerleri normal
    return np.where(s.str.contains("iptal"), "iptal", "normal")

def to_month(dt):
    return dt.dt.to_period("M").astype(str)

def to_iso_week(dt):
    # pandas >= 1.1: dt.isocalendar() var
    iso = dt.dt.isocalendar()
    return iso["year"].astype(str) + "-W" + iso["week"].astype(str).str.zfill(2)

# =========================
# 2) OKU + TEMÄ°ZLE
# =========================
df = pd.read_csv(FILE_PATH, sep=CSV_SEP, engine="python", on_bad_lines="skip")

# Opsiyonel kolonlarÄ± tespit et
COL_CANCEL_REASON = pick_col(df, CAND_CANCEL_REASON)
COL_BRANCH = pick_col(df, CAND_BRANCH)
COL_COMPANY = pick_col(df, CAND_COMPANY)
COL_PRODUCT = pick_col(df, CAND_PRODUCT)

# Segment kolonunu bul (ilk bulduÄŸunu kullan)
COL_SEGMENT = pick_col(df, CAND_SEGMENT)

# Tarih parse (TR formatÄ±)
df[COL_TANZIM] = pd.to_datetime(df[COL_TANZIM], dayfirst=True, errors="coerce")

# Tip normalize
df["_tip_norm"] = normalize_tip(df[COL_TIP])

# =========================
# 3) Ä°Å KURALI: SATIÅ / ZEYÄ°L / Ä°PTAL
# =========================
# sale_date: poliÃ§e iÃ§indeki en eski NORMAL tanzim tarihi
sale_date = (
    df[df["_tip_norm"] == "normal"]
    .groupby(COL_POLICY)[COL_TANZIM]
    .min()
    .rename("sale_date")
)

# cancel_date: poliÃ§e iÃ§indeki en erken Ä°PTAL tanzim tarihi (ilk iptal)
cancel_date = (
    df[df["_tip_norm"] == "iptal"]
    .groupby(COL_POLICY)[COL_TANZIM]
    .min()
    .rename("cancel_date")
)

df = df.merge(sale_date, on=COL_POLICY, how="left")
df = df.merge(cancel_date, on=COL_POLICY, how="left")

# KayÄ±t sÄ±nÄ±fÄ±: satÄ±ÅŸ / zeyil / iptal
df["kayÄ±t_sÄ±nÄ±fÄ±"] = np.select(
    [
        df["_tip_norm"] == "iptal",
        (df["_tip_norm"] == "normal") & (df[COL_TANZIM] == df["sale_date"]),
        (df["_tip_norm"] == "normal") & (df[COL_TANZIM] > df["sale_date"]),
    ],
    ["iptal", "satÄ±ÅŸ", "zeyil"],
    default="bilinmiyor"
)

# PoliÃ§e yaÅŸam sÃ¼resi (gÃ¼n): sadece iptali olanlarda dolu
df["poliÃ§e_yaÅŸam_gÃ¼n"] = (df["cancel_date"] - df["sale_date"]).dt.days

# =========================
# 4) POLÄ°Ã‡E BAZLI Ã–ZET TABLO (KPI'lar bunun Ã¼zerinden)
# =========================
# SatÄ±ÅŸ kaydÄ±nÄ±n satÄ±rÄ±nÄ± yakala (poliÃ§e bazÄ±nda tek)
sales_rows = df[df["kayÄ±t_sÄ±nÄ±fÄ±"] == "satÄ±ÅŸ"].copy()

# Ä°ptal kaydÄ±nÄ±n satÄ±rÄ±nÄ± yakala (poliÃ§e bazÄ±nda cancel_date'e eÅŸit iptal satÄ±rÄ±)
cancel_rows = df[(df["_tip_norm"] == "iptal") & (df[COL_TANZIM] == df["cancel_date"])].copy()

# SatÄ±ÅŸtan branÅŸ/ÅŸirket/Ã¼rÃ¼n gibi Ã¶zellikleri poliÃ§e bazÄ±na taÅŸÄ±
policy_base = pd.DataFrame({COL_POLICY: df[COL_POLICY].dropna().unique()})
policy_base = policy_base.merge(sale_date.reset_index(), on=COL_POLICY, how="left")
policy_base = policy_base.merge(cancel_date.reset_index(), on=COL_POLICY, how="left")

# SatÄ±ÅŸ kaydÄ±ndan alanlar
if COL_BRANCH:
    tmp = sales_rows[[COL_POLICY, COL_BRANCH]].drop_duplicates(COL_POLICY)
    policy_base = policy_base.merge(tmp, on=COL_POLICY, how="left")
else:
    policy_base["AnaBrans_Fallback"] = np.nan

if COL_COMPANY:
    tmp = sales_rows[[COL_POLICY, COL_COMPANY]].drop_duplicates(COL_POLICY)
    policy_base = policy_base.merge(tmp, on=COL_POLICY, how="left")
else:
    policy_base["Sirket_Fallback"] = np.nan

if COL_PRODUCT:
    tmp = sales_rows[[COL_POLICY, COL_PRODUCT]].drop_duplicates(COL_POLICY)
    policy_base = policy_base.merge(tmp, on=COL_POLICY, how="left")
else:
    policy_base["Urun_Fallback"] = np.nan

# Segment (varsa satÄ±ÅŸ kaydÄ±ndan taÅŸÄ±mak daha stabil)
if COL_SEGMENT:
    tmp = sales_rows[[COL_POLICY, COL_SEGMENT]].drop_duplicates(COL_POLICY)
    policy_base = policy_base.merge(tmp, on=COL_POLICY, how="left")
else:
    policy_base["Segment_Fallback"] = np.nan

# Ä°ptal sebebi: iptal satÄ±rÄ±ndan al
if COL_CANCEL_REASON:
    tmp = cancel_rows[[COL_POLICY, COL_CANCEL_REASON]].drop_duplicates(COL_POLICY)
    policy_base = policy_base.merge(tmp, on=COL_POLICY, how="left")
else:
    policy_base["IptalSebebi_Fallback"] = np.nan

# PoliÃ§e yaÅŸam gÃ¼nÃ¼
policy_base["yaÅŸam_gÃ¼n"] = (policy_base["cancel_date"] - policy_base["sale_date"]).dt.days
policy_base["iptal_flag"] = policy_base["cancel_date"].notna()

# BoÅŸ kategorileri normalize et
def fill_unknown(s, label="Bilinmiyor/BoÅŸ"):
    if s is None:
        return None
    return s.astype(str).replace(["nan", "None", "NaT"], np.nan).fillna(label)

if COL_BRANCH:
    policy_base[COL_BRANCH] = fill_unknown(policy_base[COL_BRANCH])
if COL_COMPANY:
    policy_base[COL_COMPANY] = fill_unknown(policy_base[COL_COMPANY])
if COL_PRODUCT:
    policy_base[COL_PRODUCT] = fill_unknown(policy_base[COL_PRODUCT])
if COL_SEGMENT:
    policy_base[COL_SEGMENT] = fill_unknown(policy_base[COL_SEGMENT])
if COL_CANCEL_REASON:
    policy_base[COL_CANCEL_REASON] = fill_unknown(policy_base[COL_CANCEL_REASON])

# =========================
# 5) Aâ€“E KPI Ã‡IKTILARI
# =========================
# A) Genel iptal oranÄ±
total_policies = policy_base[COL_POLICY].nunique()
cancelled_policies = policy_base["iptal_flag"].sum()
cancel_rate = cancelled_policies / total_policies if total_policies else 0

kpi_A = pd.DataFrame([{
    "toplam_poliÃ§e": int(total_policies),
    "iptal_adedi": int(cancelled_policies),
    "iptal_oranÄ±": round(float(cancel_rate), 6),
    "iptal_oranÄ±_%": round(float(cancel_rate * 100), 2),
}])

# B) Ä°ptal sebebi daÄŸÄ±lÄ±mÄ± (iptalli poliÃ§eler)
if COL_CANCEL_REASON:
    kpi_B = (
        policy_base[policy_base["iptal_flag"]]
        .groupby(COL_CANCEL_REASON, dropna=False)[COL_POLICY]
        .nunique()
        .reset_index(name="iptal_poliÃ§e_adedi")
        .sort_values("iptal_poliÃ§e_adedi", ascending=False)
    )
    kpi_B["oran_%"] = (kpi_B["iptal_poliÃ§e_adedi"] / kpi_B["iptal_poliÃ§e_adedi"].sum() * 100).round(2)
else:
    kpi_B = pd.DataFrame(columns=["iptal_sebebi", "iptal_poliÃ§e_adedi", "oran_%"])

# C) Zaman trendi
# C1: Ä°ptal trendi (iptal_tarihi ay/hafta)
iptal_only = policy_base[policy_base["iptal_flag"]].copy()
iptal_only["iptal_ay"] = to_month(iptal_only["cancel_date"])
iptal_only["iptal_hafta"] = to_iso_week(iptal_only["cancel_date"])

kpi_C_month_cancel = (
    iptal_only.groupby("iptal_ay")[COL_POLICY].nunique()
    .reset_index(name="iptal_poliÃ§e_adedi")
    .sort_values("iptal_ay")
)

kpi_C_week_cancel = (
    iptal_only.groupby("iptal_hafta")[COL_POLICY].nunique()
    .reset_index(name="iptal_poliÃ§e_adedi")
    .sort_values("iptal_hafta")
)

# C2: SatÄ±ÅŸ kohortu: satÄ±ÅŸ ayÄ±na gÃ¶re sonradan iptal olan oran
policy_base["satÄ±ÅŸ_ay"] = to_month(policy_base["sale_date"])
cohort = policy_base.groupby("satÄ±ÅŸ_ay").agg(
    toplam_poliÃ§e=(COL_POLICY, "nunique"),
    iptal_poliÃ§e=("iptal_flag", "sum")
).reset_index().sort_values("satÄ±ÅŸ_ay")
cohort["iptal_oranÄ±_%"] = (cohort["iptal_poliÃ§e"] / cohort["toplam_poliÃ§e"] * 100).round(2)
kpi_C_month_cohort = cohort

# D) KÄ±rÄ±lÄ±m (branÅŸ/ÅŸirket)
def breakdown_rate(df_pol, col):
    g = df_pol.groupby(col).agg(
        toplam_poliÃ§e=(COL_POLICY, "nunique"),
        iptal_poliÃ§e=("iptal_flag", "sum")
    ).reset_index()
    g["iptal_oranÄ±_%"] = (g["iptal_poliÃ§e"] / g["toplam_poliÃ§e"] * 100).round(2)
    return g.sort_values(["iptal_oranÄ±_%", "toplam_poliÃ§e"], ascending=[False, False])

kpi_D_branch = breakdown_rate(policy_base, COL_BRANCH) if COL_BRANCH else pd.DataFrame()
kpi_D_company = breakdown_rate(policy_base, COL_COMPANY) if COL_COMPANY else pd.DataFrame()

# E) Riskli segment listesi (Top 20)
if COL_SEGMENT:
    seg = breakdown_rate(policy_base, COL_SEGMENT)
    seg = seg[seg["toplam_poliÃ§e"] >= MIN_N_FOR_RISK_LIST].copy()
    kpi_E_risky_segment = seg.head(20)
else:
    kpi_E_risky_segment = pd.DataFrame()

# =========================
# 6) YAÅAM SÃœRESÄ° DAÄILIMI (iptalli poliÃ§eler)
# =========================
life = policy_base.dropna(subset=["cancel_date", "sale_date", "yaÅŸam_gÃ¼n"]).copy()
life = life[life["yaÅŸam_gÃ¼n"] >= 0]

life["yaÅŸam_bucket"] = pd.cut(life["yaÅŸam_gÃ¼n"], bins=LIFE_BINS, labels=LIFE_LABELS)
life_dist = (
    life["yaÅŸam_bucket"]
    .value_counts(dropna=False)
    .rename_axis("yaÅŸam_aralÄ±ÄŸÄ±_gÃ¼n")
    .reset_index(name="adet")
)
life_dist["oran_%"] = (life_dist["adet"] / life_dist["adet"].sum() * 100).round(2)

# =========================
# 7) ÃœRÃœN BAZINDA ANALÄ°ZLER
# =========================
if COL_PRODUCT:
    # ÃœrÃ¼n bazÄ±nda iptal oranÄ± + yaÅŸam metrikleri
    prod = policy_base.groupby(COL_PRODUCT).agg(
        toplam_poliÃ§e=(COL_POLICY, "nunique"),
        iptal_poliÃ§e=("iptal_flag", "sum"),
        ort_yaÅŸam_gÃ¼n=("yaÅŸam_gÃ¼n", "mean"),
        medyan_yaÅŸam_gÃ¼n=("yaÅŸam_gÃ¼n", "median"),
    ).reset_index()
    prod["iptal_oranÄ±_%"] = (prod["iptal_poliÃ§e"] / prod["toplam_poliÃ§e"] * 100).round(2)
    prod["ort_yaÅŸam_gÃ¼n"] = prod["ort_yaÅŸam_gÃ¼n"].round(2)
    prod["medyan_yaÅŸam_gÃ¼n"] = prod["medyan_yaÅŸam_gÃ¼n"].round(2)
    prod = prod.sort_values(["iptal_oranÄ±_%", "toplam_poliÃ§e"], ascending=[False, False])

    # ÃœrÃ¼n iÃ§i iptal sebebi daÄŸÄ±lÄ±mÄ± (iptalli poliÃ§eler)
    if COL_CANCEL_REASON:
        prod_reason = (
            policy_base[policy_base["iptal_flag"]]
            .groupby([COL_PRODUCT, COL_CANCEL_REASON])[COL_POLICY]
            .nunique()
            .reset_index(name="iptal_poliÃ§e_adedi")
            .sort_values(["iptal_poliÃ§e_adedi"], ascending=False)
        )
        # ÃœrÃ¼n bazÄ±nda en sÄ±k iptal sebebi (mode)
        top_reason = (
            prod_reason.sort_values(["iptal_poliÃ§e_adedi"], ascending=False)
            .groupby(COL_PRODUCT)
            .head(1)
            .rename(columns={COL_CANCEL_REASON: "en_sÄ±k_iptal_sebebi"})
            [[COL_PRODUCT, "en_sÄ±k_iptal_sebebi", "iptal_poliÃ§e_adedi"]]
        )
        prod = prod.merge(top_reason, on=COL_PRODUCT, how="left")
    else:
        prod_reason = pd.DataFrame()

    # ÃœrÃ¼n bazÄ±nda yaÅŸam bucket daÄŸÄ±lÄ±mÄ±
    prod_life = life.copy()
    prod_life[COL_PRODUCT] = fill_unknown(prod_life[COL_PRODUCT])
    prod_life["yaÅŸam_bucket"] = pd.cut(prod_life["yaÅŸam_gÃ¼n"], bins=LIFE_BINS, labels=LIFE_LABELS)
    prod_life_dist = (
        prod_life.groupby([COL_PRODUCT, "yaÅŸam_bucket"])[COL_POLICY]
        .nunique()
        .reset_index(name="adet")
    )

    # ÃœrÃ¼n bazÄ±nda aylÄ±k iptal trendi (iptal ayÄ±na gÃ¶re)
    prod_cancel = iptal_only.copy()
    prod_cancel = prod_cancel.merge(policy_base[[COL_POLICY, COL_PRODUCT]], on=COL_POLICY, how="left")
    prod_cancel[COL_PRODUCT] = fill_unknown(prod_cancel[COL_PRODUCT])
    prod_cancel["iptal_ay"] = to_month(prod_cancel["cancel_date"])

    prod_trend_month = (
        prod_cancel.groupby([COL_PRODUCT, "iptal_ay"])[COL_POLICY]
        .nunique()
        .reset_index(name="iptal_poliÃ§e_adedi")
        .sort_values(["iptal_ay"])
    )

    # Riskli Ã¼rÃ¼n listesi (Top 20, min adet filtresi)
    risky_products = prod[prod["toplam_poliÃ§e"] >= MIN_N_FOR_PRODUCT_RISK].head(20).copy()
else:
    prod = pd.DataFrame()
    prod_reason = pd.DataFrame()
    prod_life_dist = pd.DataFrame()
    prod_trend_month = pd.DataFrame()
    risky_products = pd.DataFrame()

# =========================
# 8) KAYIT BAZLI & POLÄ°Ã‡E BAZLI CSV Ã‡IKTILARI
# =========================
df.to_csv("cikti_kayit_bazli.csv", index=False)
policy_base.to_csv("cikti_police_ozet.csv", index=False)

kpi_A.to_csv("kpi_A_genel_iptal_orani.csv", index=False)
kpi_B.to_csv("kpi_B_iptal_sebebi_dagilimi.csv", index=False)

kpi_C_month_cancel.to_csv("kpi_C1_iptal_trendi_aylik.csv", index=False)
kpi_C_week_cancel.to_csv("kpi_C1_iptal_trendi_haftalik.csv", index=False)
kpi_C_month_cohort.to_csv("kpi_C2_satis_kohortu_aylik.csv", index=False)

kpi_D_branch.to_csv("kpi_D_branÅŸ_bazli_iptal_orani.csv", index=False)
kpi_D_company.to_csv("kpi_D_sirket_bazli_iptal_orani.csv", index=False)

kpi_E_risky_segment.to_csv("kpi_E_riskli_segment_top20.csv", index=False)

life_dist.to_csv("kpi_yasam_suresi_dagilimi.csv", index=False)

prod.to_csv("kpi_urun_bazli_iptal_orani.csv", index=False)
prod_reason.to_csv("kpi_urun_iptal_sebebi_dagilimi.csv", index=False)
prod_life_dist.to_csv("kpi_urun_yasam_bucket_dagilimi.csv", index=False)
prod_trend_month.to_csv("kpi_urun_iptal_trendi_aylik.csv", index=False)
risky_products.to_csv("kpi_riskli_urun_top20.csv", index=False)

# =========================
# 9) KONSOL Ã–ZETÄ°
# =========================
print("\nâœ… Ã‡alÄ±ÅŸtÄ±. Ã–zet:")
print(kpi_A)

print("\nğŸ“Œ Ãœretilen dosyalar (Ã¶rnek):")
print("- cikti_police_ozet.csv (poliÃ§e bazlÄ± ana tablo)")
print("- kpi_A_genel_iptal_orani.csv")
print("- kpi_B_iptal_sebebi_dagilimi.csv")
print("- kpi_C1_iptal_trendi_aylik.csv / haftalik")
print("- kpi_D_branÅŸ_bazli_iptal_orani.csv, kpi_D_sirket_bazli_iptal_orani.csv")
print("- kpi_E_riskli_segment_top20.csv (segment kolonu bulunursa)")
print("- kpi_yasam_suresi_dagilimi.csv")
print("- kpi_urun_bazli_iptal_orani.csv + kpi_riskli_urun_top20.csv (Ã¼rÃ¼n kolonu bulunursa)")

# Kolon bulunamadÄ±ysa uyar
missing = []
for name, col in [
    ("Ä°ptal Sebebi", COL_CANCEL_REASON),
    ("Ana BranÅŸ", COL_BRANCH),
    ("Sigorta Åirketi AdÄ±", COL_COMPANY),
    ("ÃœrÃ¼n", COL_PRODUCT),
    ("Segment", COL_SEGMENT),
]:
    if col is None:
        missing.append(name)

if missing:
    print("\nâš ï¸ Bulunamayan kolonlar:", ", ".join(missing))
    print("Bu alanlara ait KPI dosyalarÄ± boÅŸ/eksik olabilir. Kolon adlarÄ±nÄ± CAND_* listelerine ekleyin.")